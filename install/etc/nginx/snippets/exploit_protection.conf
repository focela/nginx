# Exploit Protection Configuration for Nginx
# This configuration helps mitigate common web application exploits such as
# SQL injection, script injection, and file injection attacks.

## Block SQL Injection Attacks
# Prevent common SQL injection patterns such as UNION SELECT and CONCAT.
location ~* union.*select.*\( {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}
location ~* union.*all.*select.* {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}
location ~* concat.*\( {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}

## Block Script Injection Attacks
# Prevent script injections using <script> tags or encoded equivalents.
location ~* (<|%3C).*script.*(>|%3E) {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}

## Block Base64 and Encoding Exploits
# Block requests attempting to use base64 encoding and other suspicious patterns.
location ~* base64_(en|de)code\(.*\) {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}
location ~* (%24&x) {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}
location ~* (%0|%A|%B|%C|%D|%E|%F|127\.0) {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}

## Block Path Traversal and Sensitive Files
# Prevent access to sensitive files and directory traversal attacks.
location ~* \.\.\/ {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}
location ~* ~$ {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}
location ~* proc/self/environ {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}
location ~* /\.(ci|htaccess|htpasswd|git|svn) {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}

## Block File Injection Attacks
# Prevent attempts to inject files through query parameters.
location ~* [a-zA-Z0-9_]=(\.\.//?)+ {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}
location ~* [a-zA-Z0-9_]=/([a-z0-9_.]//?)+ {
    access_log {{NGINX_LOG_BLOCKED_LOCATION}}/{{NGINX_LOG_BLOCKED_FILE}} {{NGINX_LOG_BLOCKED_FORMAT}};
    deny all;
}
